%%--------------------------------------------------------------------
%% EMQX Access Control List - Least Privilege Security Model
%% Compatible with MQTT 3.1, 3.1.1, and 5.0
%%--------------------------------------------------------------------

%% Deny anonymous access (security first)
{deny, {user, "anonymous"}, publish, ["#"]}.
{deny, {user, "anonymous"}, subscribe, ["#"]}.

%% Allow authenticated users to access their own namespaces
{allow, all, publish, ["clients/${clientid}/#"]}.
{allow, all, subscribe, ["clients/${clientid}/#"]}.
{allow, all, publish, ["users/${username}/#"]}.
{allow, all, subscribe, ["users/${username}/#"]}.

%% Standard IoT topic patterns (least privilege)
{allow, all, publish, ["sensors/${clientid}/#"]}.
{allow, all, subscribe, ["sensors/${clientid}/#"]}.
{allow, all, publish, ["devices/${clientid}/#"]}.
{allow, all, subscribe, ["devices/${clientid}/#"]}.

%% Telemetry and data collection (publish only for devices)
{allow, all, publish, ["telemetry/${clientid}/#"]}.
{allow, all, publish, ["data/${clientid}/#"]}.
{allow, all, publish, ["events/${clientid}/#"]}.

%% Allow subscription to aggregated data (monitoring systems)
{allow, all, subscribe, ["telemetry/+/#"]}.
{allow, all, subscribe, ["data/+/#"]}.
{allow, all, subscribe, ["events/+/#"]}.

%% System monitoring (read-only, no publish to $SYS)
{allow, all, subscribe, ["$SYS/#"]}.
{deny, all, publish, ["$SYS/#"]}.

%% MQTT 5.0 shared subscriptions (controlled access)
{allow, all, subscribe, ["$share/group1/sensors/+/#"]}.
{allow, all, subscribe, ["$share/group1/telemetry/+/#"]}.
{deny, all, publish, ["$share/#"]}.

%% Development and testing (restrict in production)
{allow, all, publish, ["test/${clientid}/#"]}.
{allow, all, subscribe, ["test/${clientid}/#"]}.
{allow, all, publish, ["dev/${clientid}/#"]}.
{allow, all, subscribe, ["dev/${clientid}/#"]}.

%% Retained messages (controlled namespaces only)
{allow, all, publish, ["retained/${clientid}/#"]}.
{allow, all, subscribe, ["retained/+/#"]}.

%% Deny access to broker internals and control topics
{deny, all, publish, ["$SYS/#"]}.
{deny, all, publish, ["$share/#"]}.
{deny, all, publish, ["$queue/#"]}.
{deny, all, subscribe, ["$queue/#"]}.

%% Deny wildcard publishing (security measure)
{deny, all, publish, ["#"]}.
{deny, all, publish, ["+/#"]}.

%% Default deny all other topics (fail-safe)
{deny, all}.