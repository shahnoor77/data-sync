##====================================================================
## EMQX 5.x Production Configuration - Zero Validation Errors
##====================================================================

##--------------------------------------------------------------------
## Node Configuration
##--------------------------------------------------------------------
node {
  name = "emqx@127.0.0.1"
  # Cookie loaded from environment variable: EMQX_NODE__COOKIE
  data_dir = "/opt/emqx/data"
  process_limit = 2097152
  max_ports = 1048576
  dist_buffer_size = 8192
}

##--------------------------------------------------------------------
## Cluster Configuration
##--------------------------------------------------------------------
cluster {
  name = emqxcl
  discovery_strategy = manual
}

##--------------------------------------------------------------------
## Dashboard Configuration
##--------------------------------------------------------------------
dashboard {
  listeners.http {
    bind = "0.0.0.0:18083"
  }
  # Credentials loaded from environment variables:
  # EMQX_DASHBOARD__DEFAULT_USERNAME
  # EMQX_DASHBOARD__DEFAULT_PASSWORD
}

##--------------------------------------------------------------------
## Authentication Configuration
##--------------------------------------------------------------------
authentication = [
  {
    enable = true
    mechanism = password_based
    backend = built_in_database
    user_id_type = username
    password_hash_algorithm = {
      name = sha256
      #salt_rounds = 10
    }
  }
]

##--------------------------------------------------------------------
## Authorization Configuration
##--------------------------------------------------------------------
authorization {
  no_match = deny
  deny_action = ignore
  cache {
    enable = true
    max_size = 32
    ttl = 60000
  }
  sources = [
    {
      type = built_in_database
      enable = true
    },
    {
      type = file
      enable = true
      path = "/opt/emqx/etc/acl.conf"
    }
  ]
}

##--------------------------------------------------------------------
## MQTT Listeners
##--------------------------------------------------------------------

## TCP Listener (Plain MQTT)
listeners.tcp.default {
  bind = "0.0.0.0:1883"
  max_connections = 1000000
  max_conn_rate = 1000
  acceptors = 16
}

## SSL Listener (MQTT over TLS)
listeners.ssl.default {
  bind = "0.0.0.0:8883"
  max_connections = 1000000
  max_conn_rate = 1000
  acceptors = 16
  
  ssl_options {
    keyfile = "/opt/emqx/etc/certs/server-key.pem"
    certfile = "/opt/emqx/etc/certs/server-cert.pem"
    cacertfile = "/opt/emqx/etc/certs/ca-cert.pem"
    verify = verify_peer
    fail_if_no_peer_cert = false
    secure_renegotiate = true
    reuse_sessions = true
    honor_cipher_order = true
    versions = ["tlsv1.2", "tlsv1.3"]
    ciphers = [
      "ECDHE-ECDSA-AES256-GCM-SHA384",
      "ECDHE-RSA-AES256-GCM-SHA384",
      "ECDHE-ECDSA-CHACHA20-POLY1305",
      "ECDHE-RSA-CHACHA20-POLY1305",
      "ECDHE-ECDSA-AES128-GCM-SHA256",
      "ECDHE-RSA-AES128-GCM-SHA256"
    ]
  }
}

## WebSocket Listener
listeners.ws.default {
  bind = "0.0.0.0:8083"
  max_connections = 1000000
  max_conn_rate = 1000
  acceptors = 16
  
  websocket {
    mqtt_path = "/mqtt"
    compress = true
  }
}

## WebSocket over SSL Listener
listeners.wss.default {
  bind = "0.0.0.0:8084"
  max_connections = 1000000
  max_conn_rate = 1000
  acceptors = 16
  
  websocket {
    mqtt_path = "/mqtt"
    compress = true
  }
  
  ssl_options {
    keyfile = "/opt/emqx/etc/certs/server-key.pem"
    certfile = "/opt/emqx/etc/certs/server-cert.pem"
    cacertfile = "/opt/emqx/etc/certs/ca-cert.pem"
    verify = verify_peer
    fail_if_no_peer_cert = false
    versions = ["tlsv1.2", "tlsv1.3"]
  }
}

##--------------------------------------------------------------------
## MQTT Protocol Configuration
##--------------------------------------------------------------------
mqtt {
  idle_timeout = 15000
  max_packet_size = "1MB"
  max_clientid_len = 65535
  max_topic_levels = 128
  max_qos_allowed = 2
  max_topic_alias = 65535
  retain_available = true
  wildcard_subscription = true
  shared_subscription = true
  ignore_loop_deliver = false
  strict_mode = false
  response_information = ""
  server_keepalive = disabled
  keepalive_multiplier = 1.5
  max_subscriptions = infinity
  upgrade_qos = false
  max_inflight = 32
  retry_interval = 30000
  max_awaiting_rel = 100
  await_rel_timeout = 300000
  session_expiry_interval = 7200000
  max_mqueue_len = 1000
  mqueue_priorities = disabled
  mqueue_default_priority = lowest
  mqueue_store_qos0 = true
  use_username_as_clientid = false
  peer_cert_as_username = disabled
  peer_cert_as_clientid = disabled
}

##--------------------------------------------------------------------
## Performance Tuning
##--------------------------------------------------------------------
force_gc {
  enable = true
  count = 16000
  bytes = "16MB"
}

overload_protection {
  enable = true
  backoff_delay = 1000
  backoff_gc = true
  backoff_hibernation = true
  backoff_new_conn = true
}

force_shutdown {
  enable = true
  max_mailbox_size = 1000
  max_heap_size = "32MB"
}

##--------------------------------------------------------------------
## System Monitor
##--------------------------------------------------------------------
sysmon {
  vm {
    process_check_interval = 30000
    process_high_watermark = "80%"
    process_low_watermark = "60%"
    long_gc = 0
    long_schedule = 240
    large_heap = "8MB"
    busy_dist_port = true
    busy_port = true
  }
  os {
    cpu_check_interval = 60000
    cpu_high_watermark = "80%"
    cpu_low_watermark = "60%"
    mem_check_interval = 60000
    sysmem_high_watermark = "70%"
    procmem_high_watermark = "5%"
  }
  top {
    num_items = 10
    sample_interval = 2000
    max_procs = 1000000
    db_hostname = ""
    db_port = 0
  }
}

##--------------------------------------------------------------------
## RPC Configuration
##--------------------------------------------------------------------
rpc {
  mode = async
  async_batch_size = 256
  port_discovery = manual
  tcp_server_port = 5369
  tcp_client_num = 10
  connect_timeout = 5000
  certfile = "/opt/emqx/etc/certs/server-cert.pem"
  keyfile = "/opt/emqx/etc/certs/server-key.pem"
  cacertfile = "/opt/emqx/etc/certs/ca-cert.pem"
}

##--------------------------------------------------------------------
## Logging Configuration
##--------------------------------------------------------------------
log {
  console_handler {
    enable = true
    level = info
    formatter = text
    time_offset = system
  }
  
  file_handlers.default {
    enable = true
    level = info
    file = "/opt/emqx/log/emqx.log"
    rotation_size = "50MB"
    rotation_count = 10
    formatter = text
  }
}

##--------------------------------------------------------------------
## Statistics Configuration
##--------------------------------------------------------------------
stats {
  enable = true
}

##--------------------------------------------------------------------
## Retainer Configuration
##--------------------------------------------------------------------
retainer {
  enable = true
  msg_expiry_interval = 0
  msg_clear_interval = 0
  max_payload_size = "1MB"
  stop_publish_clear_msg = false
  
  backend {
    type = built_in_database
    storage_type = disc
    max_retained_messages = 0
  }
}

##--------------------------------------------------------------------
## Delayed Publish Configuration
##--------------------------------------------------------------------
delayed {
  enable = true
  max_delayed_messages = 0
}

##--------------------------------------------------------------------
## Auto Subscribe Configuration
##--------------------------------------------------------------------
auto_subscribe {
  topics = []
}

##--------------------------------------------------------------------
## Flapping Detection
##--------------------------------------------------------------------
flapping_detect {
  enable = false
  max_count = 15
  window_time = "1m"
  ban_time = "5m"
}